---
const ACCESS_KEY = import.meta.env.PUBLIC_WEB3FORMS_KEY;
const FORM_URL_SEND = import.meta.env.PUBLIC_FORM_URL_SEND;
const REDIRECT_URL = import.meta.env.PUBLIC_FORM_REDIRECT_URL;
---

<form
  id="myForm"
  action={FORM_URL_SEND}
  method="POST"
  class="max-w-3xl py-11 px-6 sm:px-12 md:px-8 mx-auto"
>
  <!-- Tu clave de Web3Forms -->
  <input type="hidden" name="access_key" value={ACCESS_KEY} />

  <!-- Redirección (si deseas) -->
  <input type="hidden" name="redirect" value={REDIRECT_URL} />

  <h1 class="text-3xl font-bold mb-4 px-3">CONTÁCTANOS</h1>
  <p class="mb-6 px-3">
    ¿Estás interesado en algún producto y/o servicio? <br />
    Llena el siguiente formulario y nos pondremos en contacto.
  </p>

  <div class="flex flex-wrap mb-6">
    <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
      <label class="block text-gray-700 text-sm mb-2" for="form-name">
        Nombre
      </label>
      <input
        name="name"
        class="block w-full bg-gray-200 text-gray-700 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white"
        id="form-name"
        type="text"
        required
      />
    </div>
    <div class="w-full md:w-1/2 px-3">
      <label class="block text-gray-700 text-sm mb-2" for="form-company">
        Compañía
      </label>
      <input
        name="company"
        class="block w-full bg-gray-200 text-gray-700 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white"
        id="form-company"
        type="text"
        required
      />
    </div>
  </div>

  <div class="flex flex-wrap mb-6">
    <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
      <label class="block text-gray-700 text-sm mb-2" for="form-email">
        E-mail
      </label>
      <input
        name="email"
        class="block w-full bg-gray-200 text-gray-700 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white"
        id="form-email"
        type="email"
        required
      />
    </div>
    <div class="w-full md:w-1/2 px-3">
      <label class="block text-gray-700 text-sm mb-2" for="form-tel">
        Teléfono
      </label>
      <input
        name="phone"
        class="block w-full bg-gray-200 text-gray-700 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white"
        id="form-tel"
        type="tel"
        required
      />
    </div>
  </div>

  <div class="w-full px-3 mb-6">
    <label class="block text-gray-700 text-sm mb-2" for="form-area">
      Consulta
    </label>
    <textarea
      name="message"
      class="block w-full bg-gray-200 text-gray-700 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white"
      id="form-area"
      rows="6"
      required
    ></textarea>
  </div>

  <!-- Contenedor hCaptcha -->
  <div
    class="h-captcha px-3"
    data-captcha="true"
    data-lang="es"
    data-theme="light"
    data-onload="myFunction"
    data-render="onload"
    data-size="normal"
    data-error-callback="onError"
  ></div>

  <!-- Mensaje de error oculto (solo se muestra si el captcha no está llenado) -->
  <div 
    id="captchaError" 
    class="hidden px-3 text-red-600 text-sm mt-1"
  ></div>

  <div class="text-right px-3">
    <button
      type="submit"
      class="w-full sm:w-auto md:w-auto py-2 px-6 bg-blue-500 hover:bg-blue-600 text-white rounded font-bold cursor-pointer"
    >
      Enviar
    </button>
  </div>
</form>

<!-- Script de Web3Forms + hCaptcha -->
<script src="https://web3forms.com/client/script.js" async defer></script>

<!-- Script para reiniciar captcha (Astro SPA) y mostrar error sin alert -->
<script is:inline>
  // Resetea hCaptcha al entrar con ClientRouter
  document.addEventListener('astro:page-load', () => {
    if (window.hcaptcha) {
      window.hcaptcha.reset();
    }
  });

  // Al enviar, verifica si el captcha está resuelto
  const form = document.getElementById("myForm");
  if(form) {
    form.addEventListener("submit", (e) => {
      const errorDiv = document.getElementById("captchaError");
      // Limpia error previo
      if (errorDiv) {
        errorDiv.textContent = "";
        errorDiv.classList.add("hidden");
      }

      // Revisa token captcha
      const captchaToken = document.querySelector('textarea[name="h-captcha-response"]')?.value;
      if (!captchaToken) {
        e.preventDefault();
        if (errorDiv) {
          errorDiv.textContent = "Por favor, completa el captcha antes de enviar.";
          errorDiv.classList.remove("hidden");
        }
        return;
      }

      // Deshabilita botón
      const submitBtn = e.target.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
      }
    });
  }
</script>
